<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/adminDashboard.css">

    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/addStaff.css">



    <title>HOME</title>
</head>
<body>
<div class=" sidebar" th:include="sidebar::sidebar"></div>
<section class="mainBody">
<div  class="headerContainer" th:include="header::header">

</div>
<main class="adminBody">
    <section id="dashboard" class="section">
        <div class="main" th:include="dashboardAndStaff::admindashboard"></div>
    </section>
    <section id="staff" class="section" > 
        <div class="main" th:include="dashboardAndStaff::staff"></div>
    </section>
    <section id="patients" class="section" >
        <div class="main" th:include="register::user"></div>

    </section>
    <section id="appointments" class="section">
        <div class=" main " th:include="viewAppointments::appointments"></div>

    </section>
    <section id="settings" class="section" >Settings</section>

</main>
</section>
<script src="js/sidebar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="js/populateRoles.js"></script>
<script>
    document.getElementById('role').addEventListener('change', function() {
        var role = this.value;
        console.log("Selected Role:", role);

        var availabilitySection = document.getElementById('availability-section');

        if (role == "2") {
            availabilitySection.style.display = 'block'; // Show availability section
        } else {
            availabilitySection.style.display = 'none'; // Hide availability section
        }
    });



    document.addEventListener("DOMContentLoaded", async () => {
        try {
            // Fetch user role
            const roleResponse = await fetch('api/auth/role', {
                method: 'GET',
                credentials: 'same-origin'  // Ensure cookies are sent with the request
            });
            if (!roleResponse.ok) {
                console.error("Failed to fetch role:", roleResponse.status);
                return;
            }
            const userRole = await roleResponse.text();
            console.log("Fetched userRole:", userRole);

            // Fetch appointments
            const appointmentResponse = await fetch('/appointment/list', {
                method: 'GET',
                credentials: 'same-origin'  // Ensure cookies are sent with the request
            });
            if (!appointmentResponse.ok) {
                console.error("Failed to fetch appointments:", appointmentResponse.status);
                return;
            }

            const appointments = await appointmentResponse.json();
            console.log("Appointments data:", appointments);

            const tbody = document.getElementById('appointmentTableBody');
            const doctorColumnIndex = 1; // Assuming the "Doctor" column is the second column (index 1)

            // Hide the "Doctor" column if the role is ROLE_DOCTOR
            if (userRole === 'ROLE_DOCTOR') {
                const headers = document.querySelectorAll('.Table thead tr td'); // Target the headers
                headers[doctorColumnIndex].style.display = 'none'; // Hide the "Doctor" header

                const rows = tbody.querySelectorAll('tr'); // Target table rows
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > doctorColumnIndex) {
                        cells[doctorColumnIndex].style.display = 'none'; // Hide the "Doctor" column cells
                    }
                });
            }

            // Render appointments
            if (Array.isArray(appointments)) {
                appointments.forEach(appointment => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', appointment.appointmentID); // Use appointmentID as unique identifier

                    row.innerHTML = `
                    <td>${appointment.patientID?.name || 'Unknown Patient'}</td>
                    <td>${appointment.doctorID?.staffName || 'Unknown Doctor'}</td>
                    <td>${appointment.appDate || 'N/A'}</td>
                    <td>${appointment.appTime || 'N/A'}</td>
                    <td>${appointment.status || 'N/A'}</td>
                    <td class="actions">
                        ${userRole === 'ROLE_ADMIN' ? `
                            <button onclick="editAppointment('${appointment.appointmentID}')">Edit</button>
                            <button onclick="deleteAppointment('${appointment.appointmentID}')">Delete</button>
                        ` : ''}
                        ${userRole === 'ROLE_DOCTOR' ? `
                            <button onclick="startAppointment('${appointment.appointmentID}')">Start</button>
                        ` : ''}
                    </td>
                `;
                    tbody.appendChild(row);
                });

                // After adding rows, hide the doctor column for rows as well
                if (userRole === 'ROLE_DOCTOR') {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length > doctorColumnIndex) {
                            cells[doctorColumnIndex].style.display = 'none'; // Hide the "Doctor" column cells
                        }
                    });
                }
            } else {
                console.error("Expected an array, but got:", appointments);
                tbody.innerHTML = `<tr><td colspan="6">No appointments found</td></tr>`;
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    });






</script>


</body>
</html>