<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/adminDashboard.css">

    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/addStaff.css">



    <title>HOME</title>
</head>
<body>
<div class=" sidebar" th:include="sidebar::sidebar"></div>
<section class="mainBody">
<div  class="headerContainer" th:include="header::header">

</div>
<main class="adminBody">
    <section id="dashboard" class="section">
        <div class="main" th:include="dashboardAndStaff::admindashboard"></div>
    </section>
    <section id="staff" class="section" > 
        <div class="main" th:include="dashboardAndStaff::staff"></div>
    </section>
    <section id="patients" class="section" >
        <div class="main" th:include="register::user"></div>

    </section>
    <section id="appointments" class="section">
        <div class=" main " th:include="viewAppointments::appointments"></div>

    </section>
    <section id="settings" class="section" >Settings</section>

</main>
</section>
<script src="js/sidebar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="js/populateRoles.js"></script>
<script>
    document.getElementById('role').addEventListener('change', function() {
        var role = this.value;
        console.log("Selected Role:", role);

        var availabilitySection = document.getElementById('availability-section');

        if (role == "2") {
            availabilitySection.style.display = 'block'; // Show availability section
        } else {
            availabilitySection.style.display = 'none'; // Hide availability section
        }
    });



    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const roleResponse = await fetch('api/auth/role', { method: 'GET', credentials: 'same-origin' });
            if (!roleResponse.ok) {
                console.error("Failed to fetch role:", roleResponse.status);
                return;
            }
            const userRole = await roleResponse.text();
            console.log("User Role:", userRole);

            const appointmentResponse = await fetch('/appointment/list', { method: 'GET', credentials: 'same-origin' });
            if (!appointmentResponse.ok) {
                console.error("Failed to fetch appointments:", appointmentResponse.status);
                return;
            }
            const appointments = await appointmentResponse.json();
            const tbody = document.getElementById('appointmentTableBody');
            const doctorColumnIndex = 1;

            if (userRole === 'ROLE_DOCTOR') {
                const headers = document.querySelectorAll('.Table thead tr td');
                headers[doctorColumnIndex].style.display = 'none';
            }

            if (Array.isArray(appointments)) {
                appointments.forEach(appointment => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', appointment.appointmentID);

                    row.innerHTML = `
                        <td>${appointment.patientID?.name || 'Unknown Patient'}</td>
                        <td>${appointment.doctorID?.staffName || 'Unknown Doctor'}</td>
                        <td>${appointment.appDate || 'N/A'}</td>
                        <td>${appointment.appTime || 'N/A'}</td>
                        <td>${appointment.status || 'N/A'}</td>
                        <td class="actions">
                            <button type="button" class="edit" onclick="openEditModal('${appointment.appointmentID}', '${appointment.appDate}', '${appointment.appTime}', '${appointment.status}')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
\t<g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
\t\t<path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
\t\t<path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z" />
\t</g>
</svg></button>
                            ${userRole === 'ROLE_DOCTOR' ? `<button type="submit" class="primary" onclick="startAppointment('${appointment.appointmentID}')">Start</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                if (userRole === 'ROLE_DOCTOR') {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length > doctorColumnIndex) {
                            cells[doctorColumnIndex].style.display = 'none';
                        }
                    });
                }
            } else {
                tbody.innerHTML = `<tr><td colspan="6">No appointments found</td></tr>`;
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    });

    function openEditModal(id, appDate, appTime, status) {


        document.getElementById('editAppointmentID').value = id;
        document.getElementById('editAppDate').value = appDate;
        document.getElementById('editAppTime').value = appTime;
        document.getElementById('editStatus').value = status;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function saveAppointmentChanges() {
        const appointmentID = document.getElementById("editAppointmentID").value;
        const appDate = document.getElementById("editAppDate").value;
        const appTime = document.getElementById("editAppTime").value;
        const status = document.getElementById("editStatus").value;

        // Prepare the form data
        const data = new URLSearchParams();
        data.append("appointmentID", appointmentID);
        data.append("date", appDate || '');  // Send empty string if no date is selected
        data.append("time", appTime || '');  // Send empty string if no time is selected
        data.append("status", status || '');  // Send empty string if no status is selected

        fetch("/appointment/edit", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: data.toString(),
        })
            .then(response => response.text())
            .then(data => {
                console.log(data); // Show success message
                closeEditModal(); // Close the modal after editing
                location.reload(); // Optionally reload the page to reflect changes
            })
            .catch(error => {
                console.error("Error editing appointment:", error);
            });
    }






</script>


</body>
</html>